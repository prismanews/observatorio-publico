name: Observatorio PÃºblico - ActualizaciÃ³n AutomÃ¡tica

on:
  # EjecuciÃ³n manual desde la interfaz de GitHub
  workflow_dispatch:
  
  # AutomÃ¡tica cada 6 horas
  schedule:
    - cron: "0 */6 * * *"
  
  # TambiÃ©n al hacer push a main (opcional, por si quieres actualizar al subir cÃ³digo)
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

# Permisos necesarios
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  actualizar-observatorio:
    name: ğŸ”„ Actualizar datos del Observatorio
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtener el cÃ³digo
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Obtiene todo el historial para comparar cambios

      # 2. Configurar Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'  # Cachea dependencias para mayor velocidad

      # 3. Instalar dependencias necesarias
      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade \
            pandas \
            requests \
            feedparser \
            reportlab \
            beautifulsoup4 \
            lxml \
            numpy \
            matplotlib

      # 4. Crear estructura de directorios
      - name: ğŸ“ Preparar directorios
        run: |
          mkdir -p datos
          mkdir -p api
          mkdir -p assets
          echo "âœ… Directorios creados"

      # 5. Generar todos los datos del Observatorio
      - name: ğŸš€ Ejecutar generador principal
        run: python generar_datos.py
        env:
          TZ: 'Europe/Madrid'
          PYTHONUNBUFFERED: 1  # Para ver logs en tiempo real

      # 6. Verificar que los archivos se generaron correctamente
      - name: âœ… Validar archivos generados
        run: |
          # Lista de archivos requeridos
          archivos=(
            "datos/boe.json"
            "datos/alertas.json"
            "datos/subvenciones.json"
            "datos/gasto.json"
            "datos/promesas.json"
            "datos/informe_transparencia.pdf"
            "index.html"
            "manifest.json"
          )
          
          for archivo in "${archivos[@]}"; do
            if [ -f "$archivo" ]; then
              echo "âœ… $archivo generado correctamente"
            else
              echo "âš ï¸  $archivo no encontrado - verificando si es necesario"
            fi
          done

      # 7. Generar GeoJSON de municipios si no existe
      - name: ğŸ—ºï¸ Verificar/Generar GeoJSON
        run: |
          if [ ! -f "datos/municipios.geojson" ]; then
            echo '{
              "type": "FeatureCollection",
              "features": [
                {
                  "type": "Feature",
                  "properties": {"name": "Madrid", "provincia": "Madrid"},
                  "geometry": {"type": "Polygon", "coordinates": [[[-3.8,40.4],[-3.6,40.4],[-3.6,40.5],[-3.8,40.5],[-3.8,40.4]]]}
                },
                {
                  "type": "Feature", 
                  "properties": {"name": "Barcelona", "provincia": "Barcelona"},
                  "geometry": {"type": "Polygon", "coordinates": [[[2.1,41.3],[2.2,41.3],[2.2,41.4],[2.1,41.4],[2.1,41.3]]]}
                }
              ]
            }' > datos/municipios.geojson
            echo "âœ… GeoJSON generado automÃ¡ticamente"
          fi

      # 8. Actualizar timestamp en el HTML
      - name: â° Actualizar timestamp
        run: |
          sed -i "s/Ãšltima actualizaciÃ³n:.*</Ãšltima actualizaciÃ³n: $(date '+%d\/%m\/%Y %H:%M')</" index.html
          echo "âœ… Timestamp actualizado"

      # 9. Verificar si hay cambios para commit
      - name: ğŸ” Verificar cambios
        id: git-check
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # AÃ±adir todos los cambios
          git add .
          
          # Verificar si hay algo para commitear
          if git diff --staged --quiet; then
            echo "ğŸ“­ No hay cambios nuevos"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ Cambios detectados"
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # Mostrar resumen de cambios
            echo "ğŸ“Š Archivos modificados:"
            git diff --staged --name-status
          fi

      # 10. Commit y push si hay cambios
      - name: ğŸ’¾ Commit automÃ¡tico
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica $(date +'%d/%m/%Y %H:%M')

          Datos actualizados:
          - BOE: $(jq length datos/boe.json 2>/dev/null || echo 'N/A') documentos
          - Alertas: $(jq length datos/alertas.json 2>/dev/null || echo 'N/A')
          - Subvenciones: $(jq length datos/subvenciones.json 2>/dev/null || echo 'N/A')
          "
          
          git push origin HEAD:${GITHUB_REF#refs/heads/}
          echo "âœ… Cambios subidos a GitHub"

      # 11. Notificar resultado
      - name: ğŸ“¢ Mostrar resumen
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "    ğŸ›ï¸  OBSERVATORIO PÃšBLICO - RESUMEN"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š ESTADÃSTICAS:"
          echo "  â€¢ BOE:           $(jq length datos/boe.json 2>/dev/null || echo '0') documentos"
          echo "  â€¢ Alertas:       $(jq length datos/alertas.json 2>/dev/null || echo '0')"
          echo "  â€¢ Subvenciones:  $(jq length datos/subvenciones.json 2>/dev/null || echo '0')"
          echo "  â€¢ Gasto:         $(jq length datos/gasto.json 2>/dev/null || echo '0') partidas"
          echo "  â€¢ Promesas:      $(jq length datos/promesas.json 2>/dev/null || echo '0')"
          echo ""
          echo "ğŸ“ ARCHIVOS GENERADOS:"
          echo "  â€¢ Informe PDF:    $([ -f datos/informe_transparencia.pdf ] && echo 'âœ…' || echo 'âŒ')"
          echo "  â€¢ Manifest PWA:   $([ -f manifest.json ] && echo 'âœ…' || echo 'âŒ')"
          echo "  â€¢ GeoJSON mapa:   $([ -f datos/municipios.geojson ] && echo 'âœ…' || echo 'âŒ')"
          echo ""
          echo "â° ActualizaciÃ³n: $(date '+%d/%m/%Y %H:%M')"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # 12. Opcional: Desplegar a GitHub Pages automÃ¡ticamente
      - name: ğŸŒ Desplegar a GitHub Pages
        if: success() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          force_orphan: true
