name: Observatorio PÃºblico

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  actualizar:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # Si existe requirements.txt, lo usa
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # InstalaciÃ³n manual si no hay requirements.txt
            pip install feedparser reportlab requests pandas beautifulsoup4 lxml numpy matplotlib
          fi

      - name: ğŸ“ Preparar directorios
        run: |
          mkdir -p datos
          mkdir -p api
          mkdir -p assets
          echo "âœ… Directorios listos"

      - name: ğŸš€ Verificar y ejecutar generador
        run: |
          # Buscar el archivo Python (ignore espacios y nÃºmeros)
          PYTHON_FILE=$(ls generar_datos*.py 2>/dev/null | head -n 1)
          
          if [ -f "$PYTHON_FILE" ]; then
            echo "âœ… Ejecutando: $PYTHON_FILE"
            python "$PYTHON_FILE"
          else
            echo "âŒ No se encuentra generar_datos.py"
            echo "Archivos en directorio:"
            ls -la
            exit 1
          fi
        env:
          TZ: 'Europe/Madrid'

      - name: âœ… Validar archivos generados
        run: |
          echo "ğŸ“Š Verificando archivos generados:"
          
          # Verificar cada archivo necesario
          if [ -f datos/boe.json ]; then
            echo "âœ… BOE: $(jq length datos/boe.json 2>/dev/null || echo '0') documentos"
          else
            echo "âš ï¸ datos/boe.json no encontrado"
          fi
          
          if [ -f datos/alertas.json ]; then
            echo "âœ… Alertas: $(jq length datos/alertas.json 2>/dev/null || echo '0')"
          else
            echo "âš ï¸ datos/alertas.json no encontrado"
          fi
          
          if [ -f index.html ]; then
            echo "âœ… index.html generado"
          else
            echo "âš ï¸ index.html no encontrado"
          fi

      - name: ğŸ’¾ Commit automÃ¡tico
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ Sin cambios para commit"
          else
            git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica $(date +'%d/%m/%Y')"
            git push
            echo "âœ… Cambios subidos"
          fi
