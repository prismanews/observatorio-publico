<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ObsPub">
    <title>Observatorio Anticorrupci√≥n</title>
    <meta name="description" content="Mapa de riesgos de corrupci√≥n en subvenciones p√∫blicas">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <link rel="stylesheet" href="estilo.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .pull-indicator {
            height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            transition: height 0.2s;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .pull-indicator.show {
            height: 44px;
        }
        @media (max-width: 390px) {
            .obs-header h1 { font-size: 1.5rem; }
            .stat-value { font-size: 1.4rem; }
            .btn { padding: 10px 12px; }
        }
        .data-table td {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .clickable {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .clickable:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        .alerta-item a {
            text-decoration: none;
            color: inherit;
        }
        .enlace-detalle {
            display: inline-block;
            margin-top: 8px;
            color: var(--secondary);
            font-size: 0.8rem;
            text-decoration: none;
        }
        .enlace-detalle:hover {
            text-decoration: underline;
        }
        .leyenda-mapa {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }
        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="pull-indicator" id="pullIndicator">‚ü≥ Suelta para actualizar los datos</div>
    
    <div class="container">
        <header class="obs-header">
            <h1>üïµÔ∏è Observatorio Anticorrupci√≥n</h1>
            <p>154 municipios ¬∑ 8 alertas activas ¬∑ 2,843,699,360‚Ç¨ en subvenciones</p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span class="badge" style="background: #10b981; padding: 6px 12px;">19/02/2026 10:47</span>
                <a href="datos/informe_transparencia.pdf" class="btn" download>
                    üì• Informe PDF
                </a>
                <button class="btn btn-outline" id="refreshBtn" style="background: rgba(255,255,255,0.2);">
                    üîÑ
                </button>
            </div>
        </header>

        <div class="obs-card" style="margin-bottom: 16px; padding: 12px;">
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value">8</div>
                    <div class="stat-label">Alertas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">7</div>
                    <div class="stat-label">Cr√≠ticas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">200</div>
                    <div class="stat-label">Subvenciones</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">40</div>
                    <div class="stat-label">BOE</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('mapa')">üó∫Ô∏è Mapa de Riesgos</div>
            <div class="tab" onclick="showTab('alertas')">üö® Alertas</div>
            <div class="tab" onclick="showTab('subvenciones')">üí∞ Subvenciones</div>
            <div class="tab" onclick="showTab('boe')">üìú BOE</div>
        </div>

        <div class="main-grid">
            <div id="mapa" class="tab-content" style="display: grid; gap: 16px;">
                <div class="obs-card">
                    <h2>üó∫Ô∏è Mapa de Riesgo de Corrupci√≥n</h2>
                    <div id="map" style="height: 400px;"></div>
                    <div class="leyenda-mapa">
                        <div class="leyenda-item"><span class="color-box" style="background:#10b981;"></span> Riesgo bajo</div>
                        <div class="leyenda-item"><span class="color-box" style="background:#eab308;"></span> Riesgo medio</div>
                        <div class="leyenda-item"><span class="color-box" style="background:#f59e0b;"></span> Riesgo alto</div>
                        <div class="leyenda-item"><span class="color-box" style="background:#ef4444;"></span> Riesgo muy alto</div>
                        <div class="leyenda-item">‚ö†Ô∏è Municipio con alerta activa</div>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-light); margin-top:8px;">
                        Intensidad del color = nivel de riesgo ¬∑ Haz clic en cualquier municipio para ver detalles
                    </p>
                </div>

                <!-- Alertas destacadas -->
                <div class="obs-card">
                    <h2>üö® Alertas Cr√≠ticas</h2>
                    <div class="alertas-container">
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2023-2387" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Diputaci√≥n de San Sebasti√°n...</div>
                                <div class="alerta-motivo">Importe de 79.959.161‚Ç¨ - 462% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ San Sebasti√°n de los Reyes
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2025-4901" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Diputaci√≥n de Cuenca</div>
                                <div class="alerta-motivo">Importe de 79.774.756‚Ç¨ - 461% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ Cuenca
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2023-4252" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Fundaci√≥n Sevilla</div>
                                <div class="alerta-motivo">Importe de 77.064.353‚Ç¨ - 442% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ Sevilla
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2024-2567" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Ayuntamiento de El Ejido</div>
                                <div class="alerta-motivo">Importe de 72.144.719‚Ç¨ - 407% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ El Ejido
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2024-9904" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Ayuntamiento de Huesca</div>
                                <div class="alerta-motivo">Importe de 72.090.600‚Ç¨ - 407% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ Huesca
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2024-4549" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Ayuntamiento de Gerona</div>
                                <div class="alerta-motivo">Importe de 68.747.717‚Ç¨ - 384% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ Gerona
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                        <a href="https://www.boe.es/diario_boe/txt.php?id=BOE-2026-1726" target="_blank" style="text-decoration: none; color: inherit;">
                            <div class="alerta-item critica">
                                <span class="alerta-tipo">üî¥ CR√çTICA</span>
                                <div class="alerta-msg">SUBVENCI√ìN EXTREMA: Universidad de Salamanca</div>
                                <div class="alerta-motivo">Importe de 68.719.343‚Ç¨ - 383% sobre la media</div>
                                <div style="font-size:0.7rem; color: var(--text-light); margin-top:6px;">
                                    Impacto: MUY ALTO ¬∑ Talavera de la Reina
                                </div>
                                <span class="enlace-detalle">Investigar ‚Üí</span>
                            </div>
                        </a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let startY = 0;
        let pulling = false;
        const pullIndicator = document.getElementById('pullIndicator');
        
        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].pageY;
            pulling = window.scrollY === 0;
        }, {passive: true});
        
        document.addEventListener('touchmove', (e) => {
            if (pulling && window.scrollY === 0 && e.touches[0].pageY > startY + 40) {
                pullIndicator.classList.add('show');
            }
        }, {passive: true});
        
        document.addEventListener('touchend', () => {
            if (pullIndicator.classList.contains('show')) {
                pullIndicator.innerHTML = '‚ü≥ Actualizando...';
                setTimeout(() => location.reload(), 300);
            }
            pullIndicator.classList.remove('show');
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'grid';
        }

        document.getElementById('refreshBtn')?.addEventListener('click', () => location.reload());

        // Inicializar mapa
        var map = L.map('map').setView([40.4168, -3.7038], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        // Cargar GeoJSON con datos de riesgo
        fetch('datos/municipios.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: (feature) => {
                        return {
                            fillColor: feature.properties.color_riesgo || '#10b981',
                            fillOpacity: 0.7,
                            color: '#2563eb',
                            weight: feature.properties.tiene_alerta ? 3 : 1.5,
                            opacity: 0.8,
                            dashArray: feature.properties.tiene_alerta ? '5, 5' : null
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const p = feature.properties;
                        const alertaIcon = p.tiene_alerta ? ' ‚ö†Ô∏è' : '';
                        layer.bindPopup(`
                            <b>${p.name}${alertaIcon}</b><br>
                            <span style="color:#2563eb;">${p.subvenciones} subvenciones</span><br>
                            <b>${p.importe_total.toLocaleString('es-ES')}‚Ç¨</b><br>
                            <span style="color:${p.color_riesgo};">Riesgo: ${p.nivel_riesgo}</span><br>
                            <small>${p.beneficiarios} beneficiarios ¬∑ ${p.ministerios} ministerios</small><br>
                            <a href="${p.url_info}" target="_blank" style="color:#2563eb;">Ver ayuntamiento ‚Üí</a>
                        `);
                    }
                }).addTo(map);
                
                // A√±adir marcadores para alertas cr√≠ticas
                const alertasCriticas = [{"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Diputaci√≥n de San Sebasti√°n...", "motivo": "Importe de 79.959.161‚Ç¨ - 462% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-06-28", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2023-2387", "municipio": "San Sebasti√°n de los Reyes", "importe": 79959161, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Diputaci√≥n de Cuenca", "motivo": "Importe de 79.774.756‚Ç¨ - 461% sobre la media", "impacto": "MUY ALTO", "fecha": "2026-01-12", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2025-4901", "municipio": "Cuenca", "importe": 79774756, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Fundaci√≥n Sevilla", "motivo": "Importe de 77.064.353‚Ç¨ - 442% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-04-27", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2023-4252", "municipio": "Sevilla", "importe": 77064353, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Ayuntamiento de El Ejido", "motivo": "Importe de 72.144.719‚Ç¨ - 407% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-10-21", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2024-2567", "municipio": "El Ejido", "importe": 72144719, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Ayuntamiento de Huesca", "motivo": "Importe de 72.090.600‚Ç¨ - 407% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-07-10", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2024-9904", "municipio": "Huesca", "importe": 72090600, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Ayuntamiento de Gerona", "motivo": "Importe de 68.747.717‚Ç¨ - 384% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-12-01", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2024-4549", "municipio": "Gerona", "importe": 68747717, "categoria": "outlier"}, {"tipo": "CR√çTICA", "icono": "üî¥", "msg": "SUBVENCI√ìN EXTREMA: Universidad de Salamanca", "motivo": "Importe de 68.719.343‚Ç¨ - 383% sobre la media", "impacto": "MUY ALTO", "fecha": "2025-10-24", "url": "https://www.boe.es/diario_boe/txt.php?id=BOE-2026-1726", "municipio": "Talavera de la Reina", "importe": 68719343, "categoria": "outlier"}];
                alertasCriticas.forEach(a => {
                    // Buscar coordenadas del municipio
                    const feature = data.features.find(f => f.properties.name === a.municipio);
                    if (feature && feature.geometry.coordinates[0][0]) {
                        const coords = feature.geometry.coordinates[0][0];
                        L.marker([coords[1], coords[0]], {
                            icon: L.divIcon({
                                html: 'üî¥',
                                className: 'marcador-alerta',
                                iconSize: [20, 20]
                            })
                        }).addTo(map).bindPopup(`
                            <b>‚ö†Ô∏è ALERTA CR√çTICA</b><br>
                            ${a.msg}<br>
                            <small>${a.motivo}</small><br>
                            <a href="${a.url}" target="_blank">Investigar ‚Üí</a>
                        `);
                    }
                });
            });
    </script>
</body>
</html>