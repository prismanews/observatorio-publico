<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ObsPub">
    <title>Observatorio de Transparencia P√∫blica</title>
    <meta name="description" content="Seguimiento de transparencia, subvenciones y gasto p√∫blico en Espa√±a">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <link rel="stylesheet" href="estilo.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .pull-indicator {
            height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            transition: height 0.2s;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .pull-indicator.show {
            height: 44px;
        }
        @media (max-width: 390px) {
            .obs-header h1 { font-size: 1.5rem; }
            .stat-value { font-size: 1.4rem; }
            .btn { padding: 10px 12px; }
        }
        .data-table td {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table td:first-child {
            max-width: 100px;
        }
    </style>
</head>
<body>
    <div class="pull-indicator" id="pullIndicator">‚ü≥ Suelta para actualizar los datos</div>
    
    <div class="container">
        <header class="obs-header">
            <h1>üèõÔ∏è Observatorio de Transparencia</h1>
            <p>Monitorizando 154 municipios espa√±oles</p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span class="badge" style="background: #10b981; padding: 6px 12px;">19/02/2026 10:31</span>
                <a href="datos/informe_transparencia.pdf" class="btn" download>
                    üì• Informe PDF
                </a>
                <button class="btn btn-outline" id="refreshBtn" style="background: rgba(255,255,255,0.2);">
                    üîÑ
                </button>
            </div>
        </header>

        <div class="obs-card" style="margin-bottom: 16px; padding: 12px;">
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Alertas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">40</div>
                    <div class="stat-label">BOE</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">150</div>
                    <div class="stat-label">Subvenciones</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">760,328,407‚Ç¨</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('resumen')">üìä Resumen</div>
            <div class="tab" onclick="showTab('alertas')">üö® Alertas</div>
            <div class="tab" onclick="showTab('subvenciones')">üí∞ Subvenciones</div>
            <div class="tab" onclick="showTab('boe')">üìú BOE</div>
            <div class="tab" onclick="showTab('promesas')">üó≥Ô∏è Promesas</div>
        </div>

        <div class="main-grid">
            <div id="resumen" class="tab-content" style="display: grid; gap: 16px;">
                <div class="obs-card">
                    <h2>üö® Alertas de Riesgo</h2>
                    <div class="alertas-container">
                        
                    </div>
                </div>

                <div class="obs-card">
                    <h2>üìç Mapa Municipal</h2>
                    <div id="map" style="height: 280px;"></div>
                    <p style="font-size:0.8rem; color:var(--text-light); margin-top:8px;">
                        154 municipios monitorizados
                    </p>
                </div>

                <div class="obs-card">
                    <h2>üí∞ Subvenciones Recientes</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead><tr><th>Beneficiario</th><th>Importe</th><th>Municipio</th></tr></thead>
                            <tbody>
                                
                                <tr>
                                    <td>Ayuntamiento de...</td>
                                    <td>2,837,596‚Ç¨</td>
                                    <td>Granadilla de A...</td>
                                </tr>
                                
                                <tr>
                                    <td>Confederaci√≥n de...</td>
                                    <td>4,251,988‚Ç¨</td>
                                    <td>El Puerto de Sa...</td>
                                </tr>
                                
                                <tr>
                                    <td>Empresa Municipal...</td>
                                    <td>1,867,519‚Ç¨</td>
                                    <td>Legan√©s</td>
                                </tr>
                                
                                <tr>
                                    <td>Ayuntamiento de...</td>
                                    <td>2,402,116‚Ç¨</td>
                                    <td>Pamplona</td>
                                </tr>
                                
                                <tr>
                                    <td>Fundaci√≥n Baracaldo</td>
                                    <td>297,441‚Ç¨</td>
                                    <td>Calvi√°</td>
                                </tr>
                                
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="obs-card">
                    <h2>üí∂ Gasto P√∫blico</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead><tr><th>Concepto</th><th>Importe</th><th>Variaci√≥n</th></tr></thead>
                            <tbody>
                                
                                <tr>
                                    <td>Sanidad</td>
                                    <td>12,450,000,000‚Ç¨</td>
                                    <td style="color: green">+5.2%</td>
                                </tr>
                                
                                <tr>
                                    <td>Educaci√≥n</td>
                                    <td>8,720,000,000‚Ç¨</td>
                                    <td style="color: green">+3.1%</td>
                                </tr>
                                
                                <tr>
                                    <td>Transportes</td>
                                    <td>6,540,000,000‚Ç¨</td>
                                    <td style="color: red">-1.4%</td>
                                </tr>
                                
                                <tr>
                                    <td>Defensa</td>
                                    <td>9,870,000,000‚Ç¨</td>
                                    <td style="color: green">+7.8%</td>
                                </tr>
                                
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="obs-card">
                    <h2>üìú √öltimo BOE</h2>
                    <div>
                        
                        <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                            <span class="badge" style="background: #3b82f6;">ADMINISTRATIVO</span>
                            <div style="margin-top:8px; font-weight:500;">Sumario</div>
                            <a href="https://www.boe.es/boe/dias/2026/02/19/" target="_blank" style="color:var(--secondary); display:inline-block; margin-top:8px;">
                                üîó Ver en BOE ‚Üí
                            </a>
                        </div>
                        
                    </div>
                </div>

                <div class="obs-card">
                    <h2>üó≥Ô∏è Promesas</h2>
                    <div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Creaci√≥n de 500,000...</span>
                                <span class="badge" style="background:orange">45%</span>
                            </div>
                            <div class="progress"><div class="progress-bar" style="width:45%"></div></div>
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>100,000 viviendas...</span>
                                <span class="badge" style="background:orange">12%</span>
                            </div>
                            <div class="progress"><div class="progress-bar" style="width:12%"></div></div>
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>Reducci√≥n listas de...</span>
                                <span class="badge" style="background:orange">28%</span>
                            </div>
                            <div class="progress"><div class="progress-bar" style="width:28%"></div></div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let startY = 0;
        let pulling = false;
        const pullIndicator = document.getElementById('pullIndicator');
        
        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].pageY;
            pulling = window.scrollY === 0;
        }, {passive: true});
        
        document.addEventListener('touchmove', (e) => {
            if (pulling && window.scrollY === 0 && e.touches[0].pageY > startY + 40) {
                pullIndicator.classList.add('show');
            }
        }, {passive: true});
        
        document.addEventListener('touchend', () => {
            if (pullIndicator.classList.contains('show')) {
                pullIndicator.innerHTML = '‚ü≥ Actualizando...';
                setTimeout(() => location.reload(), 300);
            }
            pullIndicator.classList.remove('show');
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Tab:', tabName);
        }

        document.getElementById('refreshBtn')?.addEventListener('click', () => location.reload());

        var map = L.map('map').setView([40.4168, -3.7038], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        fetch('datos/municipios.geojson')
            .then(r => r.json())
            .then(data => {
                const importes = data.features.map(f => f.properties.importe_total || 0);
                const maxImporte = Math.max(...importes);
                
                L.geoJSON(data, {
                    style: (feature) => {
                        const importe = feature.properties.importe_total || 0;
                        const intensidad = maxImporte > 0 ? importe / maxImporte : 0;
                        return {
                            fillColor: `rgba(59, 130, 246, ${0.2 + intensidad * 0.5})`,
                            fillOpacity: 0.7,
                            color: '#2563eb',
                            weight: 1.5,
                            opacity: 0.8
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        const importe = props.importe_total || 0;
                        const numSub = props.subvenciones || 0;
                        layer.bindPopup(`
                            <b>${props.name}</b><br>
                            <span style="color:#2563eb;">${numSub} subvenciones</span><br>
                            <b>${importe.toLocaleString('es-ES')}‚Ç¨</b>
                        `);
                    }
                }).addTo(map);
                
                document.querySelector('p').innerHTML = `${data.features.length} municipios monitorizados`;
            });
    </script>
</body>
</html>